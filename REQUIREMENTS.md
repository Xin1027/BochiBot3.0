# 波奇Discord机器人 - 需求文档

## 项目概述

**项目名称**: 波奇Discord机器人 (Bochi Discord Bot)  
**版本**: 2.0  
**开发语言**: Node.js  
**主要框架**: Discord.js v14  

波奇是一个专为Discord服务器设计的智能图片识别与AI点评机器人。该机器人能够自动检测用户分享的图片，提供智能表情反应，并通过AI技术对图片进行个性化点评。

## 核心功能需求

### 1. 图片自动识别与反应系统

#### 1.1 基础图片检测
- **需求**: 机器人能够实时监听Discord频道中的图片消息
- **实现**: 使用Discord.js的MessageCreate事件监听，检测image/*类型的附件
- **权限要求**: 需要MESSAGE_CONTENT_INTENT权限
- **触发条件**: 用户上传任何格式的图片文件

#### 1.2 智能表情反应
- **需求**: 对检测到的图片自动添加表情反应
- **支持表情类型**: 
  - 标准Unicode表情 (👍, ❤️, 🎨, ✨, 🔥)
  - 服务器自定义表情
- **反应逻辑**: 从配置的表情池中随机选择一个进行反应
- **失败处理**: 自定义表情失败时自动降级使用标准表情

### 2. AI智能图片点评系统

#### 2.1 AI服务集成
- **支持的AI服务**:
  - Google Gemini API (主要)
  - OpenAI API (备选)
- **模型支持**:
  - Gemini: gemini-1.5-flash
  - OpenAI: gpt-4-vision-preview
- **API管理**: 支持多密钥轮询机制，提高稳定性

#### 2.2 点评功能
- **触发条件**: 只有在正确配置AI API密钥时才启用点评
- **点评语言**: 中文
- **点评风格**: 友好温馨，模拟可爱小狗波奇的语气
- **点评长度**: 控制在50字以内
- **实现方式**: 发送typing状态后通过AI API进行图片分析

#### 2.3 API配置要求
- **必须配置**: 至少配置一种AI服务的API密钥
- **无API时的行为**: 不进行点评，避免使用预设文本
- **错误处理**: API调用失败时静默处理，不影响用户体验

### 3. 频道级别个性化配置

#### 3.1 独立频道设置
- **配置项**: 每个频道可独立设置
  - 图片反应开关
  - AI点评开关
- **配置存储**: 运行时内存存储，按频道ID索引
- **默认行为**: 新频道自动继承全局设置

#### 3.2 频道管理界面
- **访问方式**: 通过机器人控制面板的"频道管理"功能
- **功能包括**:
  - 当前频道设置调整
  - 频道统计查看
  - 批量设置重置

### 4. 用户自主控制系统

#### 4.1 用户阻止功能
- **命令**: 
  - `/限制Bochi对我做出反应` - 阻止机器人反应
  - `/允许Bochi对我做出反应` - 解除反应限制
- **作用域**: 被阻止用户的所有图片消息
- **存储方式**: 使用Set数据结构存储用户ID
- **权限**: 所有用户均可使用，无需管理员权限

#### 4.2 阻止列表管理
- **管理界面**: 在机器人控制面板中显示
- **显示内容**: 
  - 被阻止用户数量
  - 用户列表（最多显示20个，超出显示省略）
- **管理功能**: 管理员可批量清空阻止列表

### 5. 统计与监控系统

#### 5.1 频道活动统计
- **统计指标**:
  - 各频道反应次数
  - 最后活动时间
  - 频道名称记录
- **数据展示**:
  - 按反应数量排序显示前10个频道
  - 总反应次数汇总
  - 中文日期格式显示

#### 5.2 系统状态监控
- **监控内容**:
  - 管理频道数量
  - 总反应次数
  - API配置状态
  - 被阻止用户数量
- **显示位置**: 机器人控制面板首页

### 6. 权限与安全系统

#### 6.1 管理员权限控制
- **权限机制**: 基于Discord角色的权限控制
- **配置范围**: 机器人所有管理功能
- **默认行为**: 未配置角色时所有用户可用
- **安全性**: 敏感操作使用Ephemeral回复

#### 6.2 Discord权限要求
- **必需权限**:
  - Guilds (基础连接)
  - GuildMessages (消息读取)
  - MessageContent (内容访问)
  - GuildEmojisAndStickers (表情使用)
- **可选权限**:
  - Add Reactions (添加反应)
  - Send Messages (发送消息)
  - Use External Emojis (外部表情)

## 用户界面需求

### 7. 统一控制面板

#### 7.1 主面板设计
- **布局**: 两行按钮布局，信息概览式设计
- **显示内容**:
  - 系统状态概览
  - 快捷统计信息
  - 被阻止用户预览
- **导航功能**: 清晰的功能分类和访问入口

#### 7.2 子功能面板
- **机器人设置**: 全局开关、表情配置、AI提示词设置
- **AI API配置**: Gemini/OpenAI API密钥和模型配置
- **频道管理**: 频道特定设置、统计查看、批量管理
- **权限设置**: 角色权限配置
- **用户阻止管理**: 阻止列表查看和管理

### 8. 命令系统

#### 8.1 斜杠命令
- **主命令**: `/bochi` - 打开机器人控制面板
- **用户命令**: 
  - `/限制Bochi对我做出反应`
  - `/允许Bochi对我做出反应`
- **管理命令**: 通过面板操作，不提供独立命令

#### 8.2 交互组件
- **按钮**: 各种设置开关和功能触发
- **选择菜单**: API服务选择、角色权限配置
- **模态框**: 文本配置输入（API密钥、提示词等）

## 技术需求

### 9. 架构设计

#### 9.1 代码结构
- **设计模式**: 单一类设计，BochiBot作为主控制器
- **配置管理**: 分层配置对象，支持运行时修改
- **事件驱动**: 基于Discord.js事件系统

#### 9.2 数据存储
- **配置数据**: 内存存储，运行时持久化
- **用户数据**: Set集合存储阻止列表
- **统计数据**: 对象结构存储频道统计

### 10. 性能与可靠性

#### 10.1 错误处理
- **API调用**: 完整的try-catch错误捕获
- **权限错误**: 自动降级和提示
- **交互错误**: 静默处理，避免用户困扰

#### 10.2 资源管理
- **连接管理**: 支持权限模式动态切换
- **内存优化**: 合理的数据结构选择
- **API限制**: 密钥轮询机制避免频率限制

## 部署需求

### 11. 环境配置

#### 11.1 运行环境
- **Node.js**: 版本20+
- **包管理**: NPM
- **部署平台**: Replit (VM部署模式)

#### 11.2 依赖管理
- **核心依赖**:
  - discord.js: ^14.22.1
  - @google/generative-ai: ^0.24.1
  - axios: ^1.11.0
  - dotenv: ^17.2.2

#### 11.3 环境变量
- **必需变量**:
  - DISCORD_TOKEN: Discord机器人令牌
- **可选变量**: AI API密钥通过机器人界面配置

## 维护与扩展

### 12. 可维护性
- **日志系统**: 完整的操作日志和错误日志
- **配置友好**: 通过UI界面进行所有配置
- **代码组织**: 功能模块化，便于维护

### 13. 可扩展性
- **API支持**: 易于添加新的AI服务提供商
- **功能扩展**: 模块化设计支持新功能添加
- **配置扩展**: 灵活的配置系统支持新选项

---

**文档版本**: 2.0  
**最后更新**: 2025年1月8日  
**维护人员**: Replit Agent